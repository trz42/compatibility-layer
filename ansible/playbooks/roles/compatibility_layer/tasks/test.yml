# Run a ReFrame test suite to validate the correctness
# of the compatibility layer installation.
---

- name: Check if ReFrame is installed
  ansible.builtin.command: reframe --version >/dev/null 2>&1
  register: reframe_exists
  ignore_errors: true
  changed_when: false
  tags:
    - test

- name: Check for python3
  ansible.builtin.command:
    cmd: "which python3"
  register: which_python3
  changed_when: which_python3.rc != 0

- name: Result for python3 check
  ansible.builtin.debug:
    msg: "{{ which_python3.stdout }}"
  changed_when: false

- name: "Check if venv exists {{ reframe_venv_dir }}"
  ansible.builtin.command:
    cmd: "ls -l {{ reframe_venv_dir }}"
  register: ls_reframe_venv_dir
  ignore_errors: true
  changed_when: false
  tags:
    - test

- name: "Result for checking {{ reframe_venv_dir }}"
  ansible.builtin.debug:
    msg: "{{ ls_reframe_venv_dir }}"
  changed_when: false

- name: Remove venv
  ansible.builtin.file:
    path: "{{ reframe_venv_dir }}"
    state: absent
  register: remove_venv
  when: ls_reframe_venv_dir.rc == 0
  ignore_errors: true

- name: Result for removing venv
  ansible.builtin.debug:
    msg: "{{ remove_venv }}"
  when: ls_reframe_venv_dir.rc == 0
  changed_when: false

- name: Install Reframe using pip if it's not installed yet
  ansible.builtin.pip:
    name: ReFrame-HPC
    virtualenv: "{{ reframe_venv_dir }}"
    virtualenv_command: python3 -m venv
    state: forcereinstall
  when: reframe_exists.rc != 0

- name: Copy ReFrame test file
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../test/compat_layer.py"
    dest: "{{ reframe_venv_dir }}/compat_layer.py"
    mode: 0644
  tags:
    - test

- name: Run ReFrame tests
  ansible.builtin.command:
    cmd: "{{ reframe_venv_dir + '/bin/' if reframe_exists.rc != 0 else '' }}reframe -r -v -c {{ reframe_venv_dir }}/compat_layer.py"
  environment:
    EESSI_VERSION: "{{ eessi_version }}"
    EESSI_OS: "{{ eessi_host_os }}"
    EESSI_ARCH: "{{ eessi_host_arch }}"
  register: reframe_cmd
  changed_when: false
  failed_when: reframe_cmd.rc != 0
  tags:
    - test
